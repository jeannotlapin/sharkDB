<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Jessica's sharks DB</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script src="http://backbonejs.org/backbone-min.js"></script>
    <style>
	.tableHeader {
		background-color : #3db5d8;
	}
	.dropdown-menu li a {
		padding: 2px 13px;
	}
	.activeCountry, .activeRFMO{
		background-color : #edf5fe;
	}
	.activeCountry:hover, .activeRFMO:hover, .doclink:hover{
		background-color : #e7f0f8;
		cursor:grab;
	}
	.list-group-item {
		padding: 5px 12px;
	}
	.list-group-item:first-child {
		border-top-right-radius: 9px;
	}
    </style>
</head>
<body>
  <nav class="navbar navbar-default navbar-static-top">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Shark Database</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul id="navSelector" class="nav navbar-nav">
        <li class="dropdown">
	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false" ><span id="currentCountry">Country</span><span class="caret"></span></a>
	<ul class="dropdown-menu" role="menu" id="countryDropdown"></ul>
        </li>
        <li class="dropdown">
	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false" ><span id="currentSpecies">Species</span><span class="caret"></span></a>
	<ul class="dropdown-menu" role="menu" id="speciesDropdown"></ul>
        </li>
        <li class="dropdown">
	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false" ><span id="currentRFMO">RFMO</span><span class="caret"></span></a>
	<ul class="dropdown-menu" role="menu" id="RFMODropdown"></ul>
        </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container -->
  </nav>
  <div class="container" id="mainContainer">
	  <h1 id="displayTitle"></h1>
	  <div class="bs-doc-section">
		  <div class="row">
			  <div class="col-lg-9">
				  <div class="panel panel-info" id="centralPanel" style='display:none;'>
				  </div>
			  </div>
			  <div class="col-lg-3">
				  <div class="panel panel-info" id="sidePanel" style='display:none;'>
				  </div>
			  </div>
		  </div>
	  </div>
  </div><!-- container -->

   <!-- Bootstrap core JavaScript
   ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="assets/js/ie10-viewport-bug-workaround.js"></script>
</body>
<script type="text/template" id="countrySidePanel">
	<div class="panel-heading">
		<h3 class="panel-title"><%= title %></h3>
	</div>
	<div class="panel-body">
		<ul class="list-group">
		<% _.each(dataArray, function (d) { %>
			<li class='list-group-item activeRFMO' data-rfmo='<%= d %>'><%= d %></li>
		<% }); %>
		</ul>
	</div>
</script>

<script type="text/template" id="speciesSidePanel">
	<div class="panel-heading">
		<h3 class="panel-title"><%= title %></h3>
	</div>
	<div class="panel-body"> Insert here map of distribution </div>
</script>

<script type="text/template" id="rfmoSidePanel">
	<div class="panel-heading">
		<h3 class="panel-title"><%= title %></h3>
	</div>
	<div class="panel-body">
		<ul class="list-group">
		<% _.each(dataArray, function (d) { %>
			<li class='list-group-item <%= ((d.link==1)?"activeCountry' data-countryid='"+d.isonumcode+"'":"'") %> ><%= countryInfoList[d.isonumcode].name %></li>
		<% }); %>
		</ul>
	</div>
</script>


<script type="text/template" id="countrySelectedDocuments">
	<table class="table table-striped table-hover">
	<thead>
		<tr class="tableHeader">
			<th>Type</th>
			<th>Title</th>
			<th>Description</th>
			<th>Year</th>
			<th>link</th>
		</tr>
	</thead>
	<tbody>
		<% _.each(dataArray, function(d){ %>
		<tr>
			<td><%= d.type %></td>
			<td><%= d.title %></td>
			<td><%= d.description %></td>
			<td><%= d.year %></td>
			<td><%= d.url %></td>
		</tr>
		<% });%>
	</tbody>
	</table>
</script>
<script type="text/template" id="speciesSelectedDocuments">
	<table class="table table-striped table-hover">
	<thead>
		<tr class="tableHeader">
			<th>Type</th>
			<th>RFMO</th>
			<th>Title</th>
			<th>Description</th>
			<th>Year</th>
			<th>link</th>
		</tr>
	</thead>
	<tbody>
		<% _.each(dataArray, function(d){ %>
		<tr>
			<td><%= d.type %></td>
			<td class='doclink' data-rfmo='<%= d.rfmo %>'><%= d.rfmo %></td>
			<td><%= d.title %></td>
			<td><%= d.description %></td>
			<td><%= d.year %></td>
			<td><%= d.url %></td>
		</tr>
		<% });%>
	</tbody>
	</table>
</script>
<script type="text/template" id="rfmoSelectedDocuments">
	<table class="table table-striped table-hover">
	<thead>
		<tr class="tableHeader">
			<th>Type</th>
			<th>Species</th>
			<th>Title</th>
			<th>Description</th>
			<th>Year</th>
			<th>link</th>
		</tr>
	</thead>
	<tbody>
		<% _.each(dataArray, function(d){ %>
		<tr>
			<td><%= d.type %></td>
			<td class='doclink' data-species='<%= d.species %>'><%= d.species %></td>
			<td><%= d.title %></td>
			<td><%= d.description %></td>
			<td><%= d.year %></td>
			<td><%= d.url %></td>
		</tr>
		<% });%>
	</tbody>
	</table>
</script>

<script type="text/template" id="selectorDropdown">
	<li><a href='#' class='ddpick' data-<%= type %>="<%= data %>"><%= name %></a></li>
</script>

<script>
var stateModel = Backbone.Model.extend({
	/* state has 3 variables: country, species and rfmo. Only one shall be != '' */
	defaults: {
		country: '',
		species : '',
		rfmo : ''
	}
});

var currentState = new stateModel();

var currentSelectorView = Backbone.View.extend({
		el : '#navSelector',

		events : {
			"click a.ddpick" : "updateCurrentState"
		},

		initialize: function (options) {
    			this.options = options || {};
			this.listenTo(this.model, 'change', this.render);

			var ddTemplate = _.template($('#selectorDropdown').html());

			/* at init, create the dropdown from the data retrieved from CVS : this object is instanciated after the CVS load/parse */
			Object.keys(countryList).sort(function (a,b) { /* sort the country by alphabetical order on name retrieved in the countryInfoList */
				return ((countryInfoList[a].name < countryInfoList[b].name)?-1:1);})
				.forEach(function (d) {this.$('#countryDropdown').append(ddTemplate({type:'country', data:+d, name:countryInfoList[d].name}));
				});

			Object.keys(speciesList).sort().forEach(function(d) {
				this.$('#speciesDropdown').append(ddTemplate({type:'species', data:d, name:d}));
				});

			Object.keys(RFMOList).sort().forEach(function(d) {
				this.$('#RFMODropdown').append(ddTemplate({type:'rfmo', data:d, name:d}));
				});
		},

		render : function() {
			/* get sub-elements country/species/rfmo and set their content */
			this.$('#currentCountry').html((this.model.get('country')=='')?'Country':countryInfoList[this.model.get('country')].name);
			this.$('#currentSpecies').html((this.model.get('species')=='')?'Species':this.model.get('species'));
			this.$('#currentRFMO').html((this.model.get('rfmo')=='')?'RFMO':this.model.get('rfmo'));

			/* title reflects the selection */
			$('#displayTitle').text((this.model.get('country')!='')?countryInfoList[this.model.get('country')].name:((this.model.get('species')!='')?this.model.get('species'):this.model.get('rfmo')));
			return this;
		},

		updateCurrentState : function (e) {
			this.model.set({country: ('country' in e.target.dataset)?e.target.dataset.country:'',
					rfmo: ('rfmo' in e.target.dataset)?e.target.dataset.rfmo:'',
					species: ('species' in e.target.dataset)?e.target.dataset.species:''});
		}

});



var currentCentralPanelView = Backbone.View.extend({
		el : '#centralPanel',

		initialize: function (options) {
			this.options = options || {};
			this.listenTo(this.model, 'change', this.render);
		},

		events : {
			"click td.doclink":"updateCurrentState"
		},

		countryTemplate : _.template($('#countrySelectedDocuments').html()),
		speciesTemplate : _.template($('#speciesSelectedDocuments').html()),
		rfmoTemplate : _.template($('#rfmoSelectedDocuments').html()),

		render : function () {
			this.$el.hide();
			if (this.model.get('country')!='') {
				/* render country table  */
				this.$el.html(this.countryTemplate({dataArray: countryList[this.model.get('country')].sort(yearSort)}));
			}
			if (this.model.get('species')!='') {
				/* render species table  */
				this.$el.html(this.speciesTemplate({dataArray: speciesList[this.model.get('species')].sort(yearSort)}));
			}
			if (this.model.get('rfmo')!='') {
				/* render rfmo table  */
				this.$el.html(this.rfmoTemplate({dataArray: RFMOList[this.model.get('rfmo')].sort(yearSort)}));
			}
			this.$el.show();
			return this;
		},

		updateCurrentState : function (e) {
			this.model.set({country: ('country' in e.target.dataset)?e.target.dataset.country:'',
					rfmo: ('rfmo' in e.target.dataset)?e.target.dataset.rfmo:'',
					species: ('species' in e.target.dataset)?e.target.dataset.species:''});
		}
});
var currentCentralPanel = new currentCentralPanelView({model: currentState});

var currentSidePanelView = Backbone.View.extend({
		el : '#sidePanel',

		initialize: function (options) {
			this.options = options || {};
			this.listenTo(this.model, 'change', this.render);
		},

		events : {
			"click li.activeCountry" : "toCountryView",
			"click li.activeRFMO" : "toRFMOView"
		},

		countryTemplate : _.template($('#countrySidePanel').html()),
		speciesTemplate : _.template($('#speciesSidePanel').html()),
		rfmoTemplate : _.template($('#rfmoSidePanel').html()),

		render : function () {
			this.$el.hide();
			if (this.model.get('country')!='') {
				/* render country membership  */
				if (countryInfoList[this.model.get('country')].rfmo.size==0) {
					this.$el.html('<div class="panel-heading"><h3 class="panel-title">Member of</h3></div>');
				} else {
					this.$el.html(this.countryTemplate({title: 'Member of', dataArray: countryInfoList[this.model.get('country')].rfmo}));
				}
			}
			if (this.model.get('species')!='') {
				/* render species distribution  */
				this.$el.html(this.speciesTemplate({title: 'Distribution'}));
			}
			if (this.model.get('rfmo')!='') {
				var rfmo = this.model.get('rfmo');
				/* render rfmo members(with links to the one having documents)  */
				var memberList = new Array(); /* extract member list : {name: , isonumcode: , link: }*/
				countryInfoList.forEach(function(d,k){
						if ($.inArray(rfmo, d.rfmo) != -1) {
							memberList.push({name : d.name, isonumcode:k, link: (k in countryList)?1:0});
						}});
				this.$el.html(this.rfmoTemplate({title: 'Members', dataArray: memberList.sort(function(a,b){return (a.name<b.name)?-1:1})}));
			}
			this.$el.show();
			return this;
		},

		toCountryView : function (e) {
			this.model.set({country: e.target.dataset.countryid, rfmo: '', species: ''});
		},

		toRFMOView : function (e) {
			this.model.set({rfmo: e.target.dataset.rfmo, country: '', species: ''});
		}
});
var currentSidePanel = new currentSidePanelView({model: currentState});

/* global arrays to store the parsed CVS data sets */
var countryList = new Array();
var speciesList = new Object();
var RFMOList = new Object();
var countryInfoList = new Array();

queue(2)
	.defer(d3.csv, "data/countryList.csv", function (d) {
			if (+d.isonumcode != 0 && !isNaN(d.isonumcode)) { /* skip invalid country code */
				if (!(+d.isonumcode in countryList)) {
					countryList[+d.isonumcode] = new Array();
				}
				countryList[+d.isonumcode].push({
					type: d.type,
					title: d.title,
					description: d.description,
					url: d.symbol,
					year: d.year
					});
				}
			}
	      )
	.defer(d3.csv, "data/RFMOList.csv", function (d) {
			/* populate RFMOList */
			if (!(d.RFMO in RFMOList)) {
				RFMOList[d.RFMO] = new Array();
			}
			RFMOList[d.RFMO].push({
				type: d.type,
				measure: d.measure,
				species: d.species,
				title: d.title,
				description: d.description,
				url: d.symbol,
				year: d.year
				});

			/* populate SpeciesList */
			if (!(d.species in speciesList)) {
				speciesList[d.species] = new Array();
			}
			speciesList[d.species].push({
				type: d.type,
				measure: d.measure,
				rfmo: d.RFMO,
				title: d.title,
				description: d.description,
				url: d.symbol,
				year: d.year
				});
			}
	      )
	.defer(d3.csv, "data/countryMembership.csv", function (d) {
			if (+d.isonumcode != 0 && !isNaN(d.isonumcode)) { /* skip invalid country code */
				countryInfoList[+d.isonumcode] = {
					name: d.name,
					iso2: d.isocode2,
					iso3: d.isocode3,
					rfmo: (d.RFMO=='')?new Array():d.RFMO.split(',')
					};
				}
			}
	      )
	.awaitAll(ready);

/* sort by most recent to less recent and alphabetical order of title for same year docs */
function yearSort(a,b) {
	 if (+a.year>+b.year) return -1;
	 if (+a.year<+b.year) return 1;
	 if (a.title>b.title) return 1;
	 return -1;
}

function ready(error, results) {
	console.log("country List "); console.log(countryList);
	console.log("RFMO List "); console.log(RFMOList);
	console.log("species List "); console.log(speciesList);
	console.log("country Info  List "); console.log(countryInfoList);
	/* create dropdown from keys of the lists and selector display */
	new currentSelectorView({model: currentState});
}

</script>
