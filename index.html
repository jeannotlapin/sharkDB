<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Jessica's sharks DB</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script src="http://backbonejs.org/backbone-min.js"></script>
    <style>
	.tableHeader {
		background-color : #3db5d8;
	}
	.dropdown-menu li a {
		padding: 2px 13px;
	}
	.activeCountry {
		background-color : #edf5fe;
	}
	.activeCountry:hover {
		background-color : #e7f0f8;
		cursor:grab;
	}
	.list-group-item {
		padding: 5px 12px;
	}
	.list-group-item:first-child {
		border-top-right-radius: 9px;
	}
    </style>
</head>
<body>
  <nav class="navbar navbar-default navbar-static-top">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">Shark Database</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul id="navSelector" class="nav navbar-nav">
        <li class="dropdown">
	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false" ><span id="currentCountry">Countries</span><span class="caret"></span></a>
	<ul class="dropdown-menu" role="menu" id="countryDropdown"></ul>
        </li>
        <li class="dropdown">
	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false" ><span id="currentSpecies">Species</span><span class="caret"></span></a>
	<ul class="dropdown-menu" role="menu" id="speciesDropdown"></ul>
        </li>
        <li class="dropdown">
	<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false" ><span id="currentRFMO">RFMO</span><span class="caret"></span></a>
	<ul class="dropdown-menu" role="menu" id="RFMODropdown"></ul>
        </li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container -->
  </nav>
  <div class="container" id="mainContainer" style="display:none;">
	  <h1 id="displayTitle"></h1>
	  <div class="bs-doc-section">
		  <div class="row">
			  <div class="col-lg-9">
				  <div class="panel panel-info">
					  <table class="table table-striped table-hover" id="displayTable"></table>
				  </div>
			  </div>
			  <div class="col-lg-3">
				  <div class="panel panel-info">
					<div class="panel-heading"><h3 class="panel-title" id="sidePanelTitle"></h3></div>
					<div class="panel-body" id="sidePanelBody"></div>
				  </div>
			  </div>
		  </div>
	  </div>
  </div><!-- container -->

   <!-- Bootstrap core JavaScript
   ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="assets/js/ie10-viewport-bug-workaround.js"></script>
</body>
<script>
var stateModel = Backbone.Model.extend({
	/* state has 3 variables: country, species and rfmo. Only one shall be != '' */
	defaults: {
		country: '',
		species : '',
		rfmo : ''
	}
});

var currentState = new stateModel();

var currentSelectorView = Backbone.View.extend({
		tagname : 'ul',

		initialize: function (options) {
    			this.options = options || {};
			this.listenTo(this.model, 'change', this.render);
		},

		render : function() {
			/* get sub-elements country/species/rfmo and set their content */
			this.$('#currentCountry').html((this.model.get('country')=='')?'Country':countryInfoList[this.model.get('country')].name);
			this.$('#currentSpecies').html((this.model.get('species')=='')?'Species':this.model.get('species'));
			this.$('#currentRFMO').html((this.model.get('rfmo')=='')?'RFMO':this.model.get('rfmo'));
			return this;
		}

});

var countrySelector = new currentSelectorView({model: currentState, el: $('#navSelector')});

var countryList = new Array();
var speciesList = new Object();
var RFMOList = new Object();
var countryInfoList = new Array();

queue(2)
	.defer(d3.csv, "data/countryList.csv", function (d) {
			if (+d.isonumcode != 0 && !isNaN(d.isonumcode)) { /* skip invalid country code */
				if (!(+d.isonumcode in countryList)) {
					countryList[+d.isonumcode] = new Array();
				}
				countryList[+d.isonumcode].push({
					type: d.type,
					title: d.title,
					description: d.description,
					url: d.symbol,
					year: d.year
					});
				}
			}
	      )
	.defer(d3.csv, "data/RFMOList.csv", function (d) {
			/* populate RFMOList */
			if (!(d.RFMO in RFMOList)) {
				RFMOList[d.RFMO] = new Array();
			}
			RFMOList[d.RFMO].push({
				type: d.type,
				measure: d.measure,
				species: d.species,
				title: d.title,
				description: d.description,
				url: d.symbol,
				year: d.year
				});

			/* populate SpeciesList */
			if (!(d.species in speciesList)) {
				speciesList[d.species] = new Array();
			}
			speciesList[d.species].push({
				type: d.type,
				measure: d.measure,
				RFMO: d.RFMO,
				title: d.title,
				description: d.description,
				url: d.symbol,
				year: d.year
				});
			}
	      )
	.defer(d3.csv, "data/countryMembership.csv", function (d) {
			if (+d.isonumcode != 0 && !isNaN(d.isonumcode)) { /* skip invalid country code */
				countryInfoList[+d.isonumcode] = {
					name: d.name,
					iso2: d.isocode2,
					iso3: d.isocode3,
					rfmo: d.RFMO.split(',')
					};
				}
			}
	      )
	.awaitAll(ready);

/* sort by most recent to less recent and alphabetical order of title for same year docs */
function yearSort(a,b) {
	 if (+a.year>+b.year) return -1;
	 if (+a.year<+b.year) return 1;
	 if (a.title>b.title) return 1;
	 return -1;
}

function displayCountry(country) {

	$('#mainContainer').hide();
	/* update status model to reflect current selection */
	currentState.set({country: country, species: '', rfmo: ''});

	/* display document list */
	$('#displayTable').html('<thead><tr class="tableHeader"><th>Type</th><th>Title</th><th>Description</th><th>Year</th><th>link</th></tr></thead><tbody></tbody>');

	var template = _.template("<tr><td><%= type %></td><td><%= title %></td><td><%= description %></td><td><%= year %></td><td><%= url %></td></tr>");

	var tbodyElement = $('#displayTable:last-child');
	countryList[country].sort(yearSort).forEach(function(d){
			tbodyElement.append(template(d));
			});

	$('#displayTitle').text(countryInfoList[country].name);

	/* get the country membership */
	$('#sidePanelTitle').text("Member of");
	var sidePanelInnerHTML = '<ul class="list-group">';
	countryInfoList[country].rfmo.forEach(function(d){
			sidePanelInnerHTML += "<li class='list-group-item activeCountry' onclick='displayRFMO(\""+d+"\")'>"+d+"</li>";
			});
	$('#sidePanelBody').html(sidePanelInnerHTML + "</ul>");

	$('#mainContainer').show();
}

function displaySpecies(species) {

	$('#mainContainer').hide();
	/* update status model to reflect current selection */
	currentState.set({country: '', species: species, rfmo: ''});

	/* display document list */
	$('#displayTable').html('<thead><tr class="tableHeader"><th>Type</th><th>Title</th><th>Description</th><th>Year</th><th>link</th></tr></thead><tbody></tbody>');

	var template = _.template("<tr><td><%= type %></td><td><%= title %></td><td><%= description %></td><td><%= year %></td><td><%= url %></td></tr>");

	var tbodyElement = $('#displayTable:last-child');
	speciesList[species].sort(yearSort).forEach(function(d){
			tbodyElement.append(template(d));
			});

	$('#displayTitle').text(species);

	/* get fish information : TODO */
	$('#sidePanelTitle').text("Distribution");
	$('#sidePanelBody').html("<div>Insert here map of distribution</div>");

	$('#mainContainer').show();
}

function displayRFMO(RFMO) {

	$('#mainContainer').hide();
	/* update status model to reflect current selection */
	currentState.set({country: '', species: '', rfmo: RFMO});

	/* display document list */
	$('#displayTable').html('<thead><tr class="tableHeader"><th>Type</th><th>Title</th><th>Description</th><th>Year</th><th>link</th></tr></thead><tbody></tbody>');

	var template = _.template("<tr><td><%= type %></td><td><%= title %></td><td><%= description %></td><td><%= year %></td><td><%= url %></td></tr>");
	var tbodyElement = $('#displayTable:last-child');
	RFMOList[RFMO].sort(yearSort).forEach(function (d){
			tbodyElement.append(template(d));
			});
	$('#displayTitle').text(RFMO);

	/* get members */
	$('#sidePanelTitle').text("Members");
	var sidePanelInnerHTML = '<ul class="list-group">';
	var memberList = new Array(); /* extract member list : {name: , isonumcode: }*/
	countryInfoList.forEach(function(d,k){if ($.inArray(RFMO, d.rfmo) != -1) {memberList.push({name : d.name, isonumcode:k});}});

	memberList.sort(function(a,b){if (a.name<b.name) return -1; return 1;}).forEach(function (d){
			sidePanelInnerHTML += "<li class='list-group-item";
			if ((+d.isonumcode in countryList)) { /* add link to country if it has some docs */
				sidePanelInnerHTML += " activeCountry' onclick='displayCountry("+d.isonumcode+")";
				}
			sidePanelInnerHTML = sidePanelInnerHTML + "'>"+d.name+"</li>";
			});
	$('#sidePanelBody').html(sidePanelInnerHTML);

	$('#mainContainer').show();
}


function ready(error, results) {
	console.log("country List "); console.log(countryList);
	console.log("RFMO List "); console.log(RFMOList);
	console.log("species List "); console.log(speciesList);
	console.log("country Info  List "); console.log(countryInfoList);
	/* create dropdown from keys of the lists */
	Object.keys(countryList).sort(function (a,b) { /* sort the country by alphabetical order on name retrieved in the countryInfoList */
			if (countryInfoList[a].name < countryInfoList[b].name) {
			return -1;}
			return 1;})
		.forEach(function(d) {
			$('#countryDropdown').append("<li onclick='displayCountry("+(+d)+")'><a href='#'>"+countryInfoList[d].name+"</a></li>");
			});

	Object.keys(speciesList).sort().forEach(function(d) {
			$('#speciesDropdown').append("<li onclick='displaySpecies(\""+d+"\")'><a href='#'>"+d+"</a></li>");
			});

	Object.keys(RFMOList).sort().forEach(function(d) {
			$('#RFMODropdown').append("<li onclick='displayRFMO(\""+d+"\")'><a href='#'>"+d+"</a></li>");
			});
}

</script>
